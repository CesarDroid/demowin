#!/bin/bash

echo "ğŸ”§ Solucionando problemas de base de datos..."
echo "=============================================="

# Usar Python 3.12 especÃ­ficamente
PYTHON_CMD="C:/Users/elray/AppData/Local/Programs/Python/Python312/python.exe"

# Terminar cualquier proceso Django que estÃ© corriendo
echo "ğŸ›‘ Terminando procesos Django..."
taskkill //F //IM python.exe 2>/dev/null || true
taskkill //F //IM python3.exe 2>/dev/null || true

# Esperar un momento
sleep 3

# Crear nueva base de datos con nombre diferente
echo "ğŸ“Š Creando nueva base de datos..."
DB_NAME="db_fresh_$(date +%s).sqlite3"

# Configurar variable temporal para la nueva base
export DATABASE_NAME="$DB_NAME"

echo "ğŸ”„ Aplicando migraciones a la nueva base: $DB_NAME"
"$PYTHON_CMD" -c "
import os, django
os.environ.setdefault('DJANGO_SETTINGS_MODULE', 'core.settings')

# Configurar base de datos temporal
from django.conf import settings
settings.DATABASES['default']['NAME'] = '$DB_NAME'

django.setup()

# Ejecutar migraciones
from django.core.management import execute_from_command_line
execute_from_command_line(['manage.py', 'migrate'])
print('âœ… Migraciones aplicadas exitosamente')
"

# Crear superusuario
echo "ğŸ‘¤ Creando usuario administrador..."
"$PYTHON_CMD" -c "
import os, django
os.environ.setdefault('DJANGO_SETTINGS_MODULE', 'core.settings')

# Configurar base de datos temporal  
from django.conf import settings
settings.DATABASES['default']['NAME'] = '$DB_NAME'

django.setup()

from django.contrib.auth.models import User
if not User.objects.filter(username='admin').exists():
    User.objects.create_superuser('admin', 'admin@winfibra.com', 'admin123')
    print('âœ… Superusuario admin creado')
else:
    print('âœ… Superusuario admin ya existe')
"

# Renombrar base nueva como principal
echo "ğŸ”„ Activando nueva base de datos..."
if [ -f "$DB_NAME" ]; then
    mv "db.sqlite3" "db_old_backup.sqlite3" 2>/dev/null || true
    mv "$DB_NAME" "db.sqlite3"
    echo "âœ… Base de datos actualizada exitosamente"
else
    echo "âŒ Error: No se pudo crear la nueva base de datos"
    exit 1
fi

# Inicializar datos demo
echo "ğŸ“‹ Inicializando datos demo..."
"$PYTHON_CMD" init_demo_data.py || {
    echo "âš ï¸  Datos demo no inicializados, continuando..."
}

echo ""
echo "ğŸ‰ Â¡Base de datos solucionada!"
echo "=============================="
echo ""
echo "ğŸš€ Iniciando servidor limpio..."
echo ""
echo "ğŸ“± URLs para probar RESPONSIVIDAD:"
echo "   ğŸ  Principal: http://localhost:8000"
echo "   ğŸ—ºï¸  Mapa: http://localhost:8000/mufas/mapa/"
echo "   ğŸ“Š Analytics: http://localhost:8000/proyectos/analytics/"
echo "   ğŸ” Admin: http://localhost:8000/admin/"
echo ""
echo "ğŸ”‘ Login: admin / admin123"
echo ""
echo "ğŸŒ Para ngrok: ./ngrok.exe http 8000"
echo ""

# Iniciar servidor
"$PYTHON_CMD" manage.py runserver 0.0.0.0:8000