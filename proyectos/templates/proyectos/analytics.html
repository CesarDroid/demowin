{% extends "base.html" %}
{% load static %}

{% block title %}Analytics Avanzado - WinFibra{% endblock %}

{% block extra_css %}
<style>
/* MOBILE RESPONSIVE OPTIMIZATIONS FOR ANALYTICS */
@media (max-width: 768px) {
    /* Header adjustments */
    .d-flex.justify-content-between {
        flex-direction: column;
        gap: 1rem;
    }
    
    /* Header buttons stack vertically */
    .d-flex.justify-content-between > div:last-child {
        display: flex;
        flex-direction: column;
        gap: 0.5rem;
    }
    
    .d-flex.justify-content-between > div:last-child .btn {
        width: 100%;
        margin: 0;
    }
    
    /* Charts containers */
    .card-custom {
        margin-bottom: 1.5rem;
    }
    
    /* Charts responsive heights */
    #projectTrendsChart {
        height: 250px !important;
    }
    
    #statusChart {
        height: 200px !important;
    }
    
    #districtChart {
        height: 200px !important;
    }
    
    /* Button groups in chart headers */
    .btn-group {
        flex-direction: column;
        width: 100%;
        gap: 0.25rem;
    }
    
    .btn-group .btn {
        border-radius: 6px !important;
        margin-bottom: 0.25rem;
    }
    
    /* Financial analysis section */
    .border-end {
        border-right: none !important;
        border-bottom: 1px solid var(--border-color) !important;
        padding-bottom: 1rem;
        margin-bottom: 1rem;
    }
    
    /* Predictive analytics cards */
    .col-md-3 {
        margin-bottom: 1rem;
    }
    
    .col-md-3 .p-3 {
        padding: 1.5rem !important;
    }
    
    /* Search input in table header */
    .input-group {
        width: 100% !important;
        margin-top: 1rem;
    }
    
    /* Table improvements */
    .table-responsive {
        font-size: 0.8rem;
    }
    
    .table td, .table th {
        padding: 0.5rem 0.25rem;
        white-space: nowrap;
    }
    
    /* Button actions in table */
    .btn-sm {
        font-size: 0.7rem;
        padding: 0.25rem 0.5rem;
    }
    
    /* Metric cards adjustments */
    .metric-card {
        padding: 1rem;
    }
    
    .metric-value {
        font-size: 1.8rem;
    }
    
    /* Progress bars */
    .progress {
        height: 10px !important;
    }
}

@media (max-width: 480px) {
    /* Extra small screens */
    
    /* Header */
    h1 {
        font-size: 1.4rem !important;
        text-align: center;
    }
    
    h1 i {
        display: block;
        margin-bottom: 0.5rem;
        font-size: 2rem;
    }
    
    /* Metric cards extra compact */
    .metric-card {
        padding: 0.75rem;
        text-align: center;
    }
    
    .metric-value {
        font-size: 1.5rem;
    }
    
    .metric-label {
        font-size: 0.8rem;
    }
    
    /* Charts even smaller */
    #projectTrendsChart {
        height: 200px !important;
    }
    
    #statusChart {
        height: 180px !important;
    }
    
    #districtChart {
        height: 180px !important;
    }
    
    /* Financial section */
    .col-6 h4 {
        font-size: 1.2rem;
    }
    
    .col-6 small {
        font-size: 0.7rem;
    }
    
    /* Predictive analytics */
    .col-md-3 .p-3 {
        padding: 1rem !important;
        text-align: center;
    }
    
    .col-md-3 i {
        font-size: 1.5rem !important;
    }
    
    .col-md-3 h6 {
        font-size: 0.9rem;
        margin-bottom: 0.5rem;
    }
    
    .col-md-3 p {
        font-size: 0.8rem;
        margin-bottom: 0;
    }
    
    /* Table even more compact */
    .table {
        font-size: 0.7rem;
    }
    
    .table td {
        padding: 0.25rem;
        vertical-align: middle;
    }
    
    .table td div {
        line-height: 1.2;
    }
    
    .table td strong {
        font-size: 0.8rem;
        display: block;
    }
    
    .table td small {
        font-size: 0.6rem;
    }
    
    /* Hide some table columns on very small screens */
    .table th:nth-child(4),
    .table td:nth-child(4),
    .table th:nth-child(5),
    .table td:nth-child(5) {
        display: none;
    }
    
    /* Card headers */
    .card-header-custom h5 {
        font-size: 1rem;
        text-align: center;
    }
    
    .card-header-custom .d-flex {
        flex-direction: column;
        gap: 1rem;
        text-align: center;
    }
}

/* Touch-friendly improvements */
@media (hover: none) {
    .btn-group .btn,
    .table .btn {
        min-height: 44px;
        display: flex;
        align-items: center;
        justify-content: center;
    }
    
    /* Larger touch targets for chart legends */
    .chart-legend {
        padding: 1rem;
    }
}

/* Landscape mobile optimization */
@media (max-width: 896px) and (orientation: landscape) {
    .container-fluid {
        padding-left: 1rem;
        padding-right: 1rem;
    }
    
    .metric-card {
        padding: 1rem;
    }
    
    .metric-value {
        font-size: 1.5rem;
    }
    
    /* Charts in landscape mode */
    #projectTrendsChart {
        height: 180px !important;
    }
    
    #statusChart {
        height: 150px !important;
    }
    
    #districtChart {
        height: 150px !important;
    }
}
</style>
{% endblock %}

{% block content %}
<div class="container-fluid py-4">
    <!-- HEADER SECTION -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="d-flex justify-content-between align-items-center">
                <div>
                    <h1 class="text-light mb-1">
                        <i class="fas fa-chart-bar text-primary me-3"></i>
                        Analytics Avanzado
                    </h1>
                    <p class="text-muted mb-0">Análisis inteligente y métricas de rendimiento</p>
                </div>
                <div>
                    <button class="btn btn-primary-custom me-2">
                        <i class="fas fa-download me-1"></i>Exportar Reporte
                    </button>
                    <button class="btn btn-success-custom">
                        <i class="fas fa-sync-alt me-1"></i>Actualizar Datos
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- PERFORMANCE METRICS -->
    <div class="row mb-4">
        <div class="col-xl-3 col-md-6 mb-3">
            <div class="metric-card fade-in-up">
                <div class="d-flex justify-content-between align-items-center mb-2">
                    <i class="fas fa-chart-line fa-2x" style="color: var(--success-green);"></i>
                    <span class="badge status-active">+23.4%</span>
                </div>
                <div class="metric-value" style="color: var(--success-green);">
                    {{ roi_promedio|default:"184.5" }}%
                </div>
                <div class="metric-label">ROI Promedio</div>
            </div>
        </div>
        
        <div class="col-xl-3 col-md-6 mb-3">
            <div class="metric-card fade-in-up">
                <div class="d-flex justify-content-between align-items-center mb-2">
                    <i class="fas fa-cogs fa-2x" style="color: var(--primary-blue);"></i>
                    <span class="badge status-active">+5.8%</span>
                </div>
                <div class="metric-value" style="color: var(--primary-blue);">
                    {{ eficiencia_promedio|default:"87.2" }}%
                </div>
                <div class="metric-label">Eficiencia Operativa</div>
            </div>
        </div>
        
        <div class="col-xl-3 col-md-6 mb-3">
            <div class="metric-card fade-in-up">
                <div class="d-flex justify-content-between align-items-center mb-2">
                    <i class="fas fa-clock fa-2x" style="color: var(--warning-orange);"></i>
                    <span class="badge status-pending">-3.2%</span>
                </div>
                <div class="metric-value" style="color: var(--warning-orange);">
                    42.8
                </div>
                <div class="metric-label">Días Promedio</div>
            </div>
        </div>
        
        <div class="col-xl-3 col-md-6 mb-3">
            <div class="metric-card fade-in-up">
                <div class="d-flex justify-content-between align-items-center mb-2">
                    <i class="fas fa-percentage fa-2x" style="color: var(--danger-red);"></i>
                    <span class="badge status-error">+1.8%</span>
                </div>
                <div class="metric-value" style="color: var(--danger-red);">
                    8.7%
                </div>
                <div class="metric-label">Tasa de Retrasos</div>
            </div>
        </div>
    </div>

    <!-- CHARTS ROW -->
    <div class="row mb-4">
        <!-- TENDENCIAS DE PROYECTOS -->
        <div class="col-xl-8 col-lg-7 mb-3">
            <div class="card-custom">
                <div class="card-header-custom p-3">
                    <div class="d-flex justify-content-between align-items-center">
                        <h5 class="mb-0 text-light">
                            <i class="fas fa-chart-area me-2"></i>
                            Tendencias de Proyectos
                        </h5>
                        <div class="btn-group btn-group-sm">
                            <button class="btn btn-primary-custom active">6M</button>
                            <button class="btn btn-outline-primary">1A</button>
                            <button class="btn btn-outline-primary">2A</button>
                        </div>
                    </div>
                </div>
                <div class="p-3">
                    <canvas id="projectTrendsChart" height="80"></canvas>
                </div>
            </div>
        </div>
        
        <!-- DISTRIBUCIÓN POR ESTADO -->
        <div class="col-xl-4 col-lg-5 mb-3">
            <div class="card-custom">
                <div class="card-header-custom p-3">
                    <h5 class="mb-0 text-light">
                        <i class="fas fa-chart-pie me-2"></i>
                        Distribución por Estado
                    </h5>
                </div>
                <div class="p-3">
                    <canvas id="statusChart" height="150"></canvas>
                </div>
            </div>
        </div>
    </div>

    <!-- ANÁLISIS POR DISTRITO -->
    <div class="row mb-4">
        <div class="col-xl-6 col-lg-6 mb-3">
            <div class="card-custom">
                <div class="card-header-custom p-3">
                    <h5 class="mb-0 text-light">
                        <i class="fas fa-map-marker-alt me-2"></i>
                        Rendimiento por Distrito
                    </h5>
                </div>
                <div class="p-3">
                    <canvas id="districtChart" height="120"></canvas>
                </div>
            </div>
        </div>
        
        <!-- ANÁLISIS FINANCIERO -->
        <div class="col-xl-6 col-lg-6 mb-3">
            <div class="card-custom">
                <div class="card-header-custom p-3">
                    <h5 class="mb-0 text-light">
                        <i class="fas fa-dollar-sign me-2"></i>
                        Análisis Financiero
                    </h5>
                </div>
                <div class="p-3">
                    <div class="row">
                        <div class="col-6 text-center border-end">
                            <h4 class="text-success">S/ 2.8M</h4>
                            <small class="text-muted">Facturación Total</small>
                        </div>
                        <div class="col-6 text-center">
                            <h4 class="text-primary">S/ 1.6M</h4>
                            <small class="text-muted">Costos Operativos</small>
                        </div>
                    </div>
                    <hr style="border-color: var(--border-color);">
                    <div class="text-center">
                        <h5 class="text-warning mb-2">S/ 1.2M Utilidad Neta</h5>
                        <div class="progress" style="height: 8px;">
                            <div class="progress-bar" style="width: 42.8%; background: var(--success-green);"></div>
                        </div>
                        <small class="text-muted mt-2 d-block">Margen: 42.8%</small>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- PREDICTIVE ANALYTICS -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="card-custom">
                <div class="card-header-custom p-3">
                    <h5 class="mb-0 text-light">
                        <i class="fas fa-brain me-2"></i>
                        Análisis Predictivo
                    </h5>
                </div>
                <div class="p-4">
                    <div class="row">
                        <div class="col-md-3 text-center">
                            <div class="p-3 rounded" style="background: rgba(0, 208, 132, 0.1);">
                                <i class="fas fa-arrow-trend-up fa-2x text-success mb-2"></i>
                                <h6 class="text-light">Predicción Q4</h6>
                                <p class="text-muted">+18% crecimiento esperado</p>
                            </div>
                        </div>
                        <div class="col-md-3 text-center">
                            <div class="p-3 rounded" style="background: rgba(0, 168, 255, 0.1);">
                                <i class="fas fa-calendar-alt fa-2x text-primary mb-2"></i>
                                <h6 class="text-light">Tiempo Promedio</h6>
                                <p class="text-muted">38 días proyectados</p>
                            </div>
                        </div>
                        <div class="col-md-3 text-center">
                            <div class="p-3 rounded" style="background: rgba(255, 165, 2, 0.1);">
                                <i class="fas fa-exclamation-triangle fa-2x text-warning mb-2"></i>
                                <h6 class="text-light">Riesgo Alto</h6>
                                <p class="text-muted">3 proyectos identificados</p>
                            </div>
                        </div>
                        <div class="col-md-3 text-center">
                            <div class="p-3 rounded" style="background: rgba(255, 56, 56, 0.1);">
                                <i class="fas fa-chart-line fa-2x text-danger mb-2"></i>
                                <h6 class="text-light">Optimización</h6>
                                <p class="text-muted">12% mejora posible</p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- DETAILED ANALYTICS TABLE -->
    <div class="row">
        <div class="col-12">
            <div class="card-custom">
                <div class="card-header-custom p-3">
                    <div class="d-flex justify-content-between align-items-center">
                        <h5 class="mb-0 text-light">
                            <i class="fas fa-table me-2"></i>
                            Análisis Detallado por Proyecto
                        </h5>
                        <div class="input-group" style="width: 250px;">
                            <input type="text" class="form-control bg-dark text-light border-secondary" placeholder="Buscar proyecto...">
                            <button class="btn btn-outline-secondary">
                                <i class="fas fa-search"></i>
                            </button>
                        </div>
                    </div>
                </div>
                <div class="p-3">
                    <div class="table-responsive">
                        <table class="table table-dark-custom">
                            <thead>
                                <tr>
                                    <th>Proyecto</th>
                                    <th>Estado</th>
                                    <th>ROI</th>
                                    <th>Eficiencia</th>
                                    <th>Días Restantes</th>
                                    <th>Riesgo</th>
                                    <th>Acción</th>
                                </tr>
                            </thead>
                            <tbody>
                                <tr>
                                    <td>
                                        <div>
                                            <strong class="text-light">Torre Empresarial Norte</strong><br>
                                            <small class="text-muted">PRY-001</small>
                                        </div>
                                    </td>
                                    <td><span class="badge status-active">En Construcción</span></td>
                                    <td class="text-success">+245%</td>
                                    <td class="text-primary">92%</td>
                                    <td class="text-warning">15 días</td>
                                    <td><span class="badge status-active">Bajo</span></td>
                                    <td>
                                        <button class="btn btn-primary-custom btn-sm">
                                            <i class="fas fa-eye me-1"></i>Ver
                                        </button>
                                    </td>
                                </tr>
                                <tr>
                                    <td>
                                        <div>
                                            <strong class="text-light">Residencial Las Flores</strong><br>
                                            <small class="text-muted">PRY-002</small>
                                        </div>
                                    </td>
                                    <td><span class="badge status-pending">Planificación</span></td>
                                    <td class="text-success">+178%</td>
                                    <td class="text-warning">76%</td>
                                    <td class="text-info">45 días</td>
                                    <td><span class="badge status-pending">Medio</span></td>
                                    <td>
                                        <button class="btn btn-primary-custom btn-sm">
                                            <i class="fas fa-eye me-1"></i>Ver
                                        </button>
                                    </td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
// Project Trends Chart
const trendsCtx = document.getElementById('projectTrendsChart').getContext('2d');
new Chart(trendsCtx, {
    type: 'line',
    data: {
        labels: ['Ene', 'Feb', 'Mar', 'Abr', 'May', 'Jun', 'Jul', 'Ago'],
        datasets: [{
            label: 'Proyectos Iniciados',
            data: [12, 19, 15, 25, 22, 28, 35, 32],
            borderColor: '#00a8ff',
            backgroundColor: 'rgba(0, 168, 255, 0.1)',
            borderWidth: 3,
            fill: true,
            tension: 0.4
        }, {
            label: 'Proyectos Completados',
            data: [8, 15, 12, 18, 20, 25, 30, 28],
            borderColor: '#00d084',
            backgroundColor: 'rgba(0, 208, 132, 0.1)',
            borderWidth: 3,
            fill: true,
            tension: 0.4
        }]
    },
    options: {
        responsive: true,
        maintainAspectRatio: false,
        plugins: {
            legend: {
                labels: { color: '#e4e6ea' }
            }
        },
        scales: {
            x: {
                ticks: { color: '#8b949e' },
                grid: { color: '#30363d' }
            },
            y: {
                ticks: { color: '#8b949e' },
                grid: { color: '#30363d' }
            }
        }
    }
});

// Status Distribution Chart
const statusCtx = document.getElementById('statusChart').getContext('2d');
new Chart(statusCtx, {
    type: 'doughnut',
    data: {
        labels: ['En Construcción', 'Planificación', 'Completados', 'Paralizados'],
        datasets: [{
            data: [45, 25, 20, 10],
            backgroundColor: [
                '#00d084',
                '#ffa502', 
                '#00a8ff',
                '#ff3838'
            ],
            borderWidth: 2,
            borderColor: '#1a1f2e'
        }]
    },
    options: {
        responsive: true,
        maintainAspectRatio: false,
        plugins: {
            legend: {
                position: 'bottom',
                labels: { 
                    color: '#e4e6ea',
                    padding: 15
                }
            }
        }
    }
});

// District Performance Chart
const districtCtx = document.getElementById('districtChart').getContext('2d');
new Chart(districtCtx, {
    type: 'bar',
    data: {
        labels: ['Miraflores', 'San Isidro', 'Surco', 'La Molina', 'Barranco'],
        datasets: [{
            label: 'Eficiencia (%)',
            data: [92, 88, 85, 78, 82],
            backgroundColor: [
                'rgba(0, 208, 132, 0.8)',
                'rgba(0, 168, 255, 0.8)',
                'rgba(255, 165, 2, 0.8)',
                'rgba(255, 56, 56, 0.8)',
                'rgba(156, 39, 176, 0.8)'
            ],
            borderWidth: 1,
            borderColor: '#30363d'
        }]
    },
    options: {
        responsive: true,
        maintainAspectRatio: false,
        plugins: {
            legend: {
                display: false
            }
        },
        scales: {
            x: {
                ticks: { color: '#8b949e' },
                grid: { color: '#30363d' }
            },
            y: {
                ticks: { color: '#8b949e' },
                grid: { color: '#30363d' },
                beginAtZero: true,
                max: 100
            }
        }
    }
});
</script>
{% endblock %}